"use strict";(self.webpackChunkstaticdocs_starter=self.webpackChunkstaticdocs_starter||[]).push([[2664],{3905:function(e,n,t){t.r(n),t.d(n,{MDXContext:function(){return d},MDXProvider:function(){return u},mdx:function(){return f},useMDXComponents:function(){return p},withMDXComponents:function(){return m}});var a=t(67294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(){return i=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a])}return e},i.apply(this,arguments)}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var d=a.createContext({}),m=function(e){return function(n){var t=p(n.components);return a.createElement(e,i({},n,{components:t}))}},p=function(e){var n=a.useContext(d),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},u=function(e){var n=p(e.components);return a.createElement(d.Provider,{value:n},e.children)},c={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},h=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,i=e.originalType,o=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),m=p(t),u=r,h=m["".concat(o,".").concat(u)]||m[u]||c[u]||i;return t?a.createElement(h,l(l({ref:n},d),{},{components:t})):a.createElement(h,l({ref:n},d))}));function f(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var i=t.length,o=new Array(i);o[0]=h;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,o[1]=l;for(var d=2;d<i;d++)o[d]=t[d];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}h.displayName="MDXCreateElement"},42153:function(e,n,t){t.r(n),t.d(n,{assets:function(){return m},contentTitle:function(){return s},default:function(){return c},frontMatter:function(){return l},metadata:function(){return d},toc:function(){return p}});var a=t(83117),r=t(80102),i=(t(67294),t(3905)),o=["components"],l={title:"File Queries",category:"Queries"},s=void 0,d={unversionedId:"file-query",id:"file-query",title:"File Queries",description:"Watchman file queries consist of 1 or more generators that feed files through",source:"@site/docs/file-query.md",sourceDirName:".",slug:"/file-query",permalink:"/watchman/docs/file-query",draft:!1,editUrl:"https://github.com/facebook/watchman/tree/main/website/docs/file-query.md",tags:[],version:"current",frontMatter:{title:"File Queries",category:"Queries"},sidebar:"tutorialSidebar",previous:{title:"Clockspec",permalink:"/watchman/docs/clockspec"},next:{title:"Source Control Aware Queries",permalink:"/watchman/docs/scm-query"}},m={},p=[{value:"Generators",id:"generators",level:3},{value:"De-duplicating results",id:"de-duplicating-results",level:3},{value:"Since Generator",id:"since-generator",level:3},{value:"Suffix Generator",id:"suffix-generator",level:3},{value:"Glob Generator",id:"glob-generator",level:3},{value:"Path Generator",id:"path-generator",level:3},{value:"All Generator",id:"all-generator",level:3},{value:"Expressions",id:"expressions",level:3},{value:"Relative roots",id:"relative-roots",level:3}],u={toc:p};function c(e){var n=e.components,t=(0,r.Z)(e,o);return(0,i.mdx)("wrapper",(0,a.Z)({},u,t,{components:n,mdxType:"MDXLayout"}),(0,i.mdx)("p",null,"Watchman file queries consist of 1 or more ",(0,i.mdx)("em",{parentName:"p"},"generators")," that feed files through\nthe ",(0,i.mdx)("em",{parentName:"p"},"expression evaluator"),"."),(0,i.mdx)("h3",{id:"generators"},"Generators"),(0,i.mdx)("p",null,"Generators are analogous to the list of ",(0,i.mdx)("em",{parentName:"p"},"paths")," that you specify when using the\n",(0,i.mdx)("inlineCode",{parentName:"p"},"find(1)")," utility, but are implemented in watchman with a bit of a twist because\nwatchman doesn't need to crawl the filesystem in realtime and instead maintains\na couple of indexes over the tree."),(0,i.mdx)("p",null,"A query may specify any number of generators; each generator will emit its list\nof files and this may mean that you see the same file output more than once if\nyou specified the use of multiple generators that all produce the same file."),(0,i.mdx)("p",null,"Watchman provides 5 generators:"),(0,i.mdx)("ul",null,(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("strong",{parentName:"li"},"since"),": produces a list of files that were modified since a specific\nclockspec."),(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("strong",{parentName:"li"},"suffix"),": produces a list of files that have a particular suffix."),(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("strong",{parentName:"li"},"glob"),": efficiently pattern match a list of files based on their names."),(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("strong",{parentName:"li"},"path"),": produces a list of files based on their path and depth."),(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("strong",{parentName:"li"},"all"),": produces a list of all known files")),(0,i.mdx)("h3",{id:"de-duplicating-results"},"De-duplicating results"),(0,i.mdx)("p",null,(0,i.mdx)("em",{parentName:"p"},"Since 4.7.")),(0,i.mdx)("p",null,"If your query uses multiple generators, or configures the ",(0,i.mdx)("inlineCode",{parentName:"p"},"path")," generator with\npaths that yield multiple results, the default behavior (for backwards\ncompatibility reasons) is to emit those duplicate results in the query output."),(0,i.mdx)("p",null,"You may ask Watchman to de-duplicate results for you by enabling the\n",(0,i.mdx)("inlineCode",{parentName:"p"},"dedup_results")," boolean in your query:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-bash"},'$ watchman -j <<-EOT\n["query", "/path/to/root", {\n  "path": ["bar", "bar"],\n  "dedup_results": true\n}]\nEOT\n')),(0,i.mdx)("p",null,"You may test for this feature using an extended version command and requesting\nthe capability name ",(0,i.mdx)("inlineCode",{parentName:"p"},"dedup_results"),"."),(0,i.mdx)("h3",{id:"since-generator"},"Since Generator"),(0,i.mdx)("p",null,"The ",(0,i.mdx)("inlineCode",{parentName:"p"},"since")," generator produces a list of files that were modified since a\nspecific ",(0,i.mdx)("a",{parentName:"p",href:"/watchman/docs/clockspec"},"clockspec"),"."),(0,i.mdx)("p",null,"The following query will consider the set of files changed since the last query\nusing the named cursor ",(0,i.mdx)("inlineCode",{parentName:"p"},"mycursor")," and then pass them to the expression evaluator\nto be filtered to just those that are files:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-bash"},'$ watchman -j <<-EOT\n["query", "/path/to/root", {\n  "since": "n:mycursor",\n  "expression": ["type", "f"]\n}]\nEOT\n')),(0,i.mdx)("p",null,"If the ",(0,i.mdx)("inlineCode",{parentName:"p"},"since")," parameter value is blank, was produced by a different watchman\nprocess (in other words, the watchman process was restarted between the time\nthat the value was obtained and the time the query was issued) or is a named\ncursor that has not yet been used in a query, the ",(0,i.mdx)("inlineCode",{parentName:"p"},"since")," generator will\nconsider the state to be a ",(0,i.mdx)("em",{parentName:"p"},"fresh instance")," and its behavior is modified:"),(0,i.mdx)("p",null,"A ",(0,i.mdx)("em",{parentName:"p"},"fresh instance")," result set will only include files that currently exist and\nwill generate file nodes that are always considered to be ",(0,i.mdx)("inlineCode",{parentName:"p"},"new"),"."),(0,i.mdx)("p",null,"If the query was configured with the ",(0,i.mdx)("inlineCode",{parentName:"p"},"empty_on_fresh_instance")," property set to\n",(0,i.mdx)("inlineCode",{parentName:"p"},"true")," then the result set will be empty and the ",(0,i.mdx)("inlineCode",{parentName:"p"},"is_fresh_instance")," property\nwill be set to ",(0,i.mdx)("inlineCode",{parentName:"p"},"true")," in the result object."),(0,i.mdx)("p",null,"The since generator also knows how to talk to source control;\n",(0,i.mdx)("a",{parentName:"p",href:"/watchman/docs/scm-query"},"you can read more about that here"),"."),(0,i.mdx)("p",null,"The ",(0,i.mdx)("inlineCode",{parentName:"p"},"since")," generator does not consider the targets of symlinks. In particular,\nthe ",(0,i.mdx)("inlineCode",{parentName:"p"},"since")," generator may ",(0,i.mdx)("em",{parentName:"p"},"not")," produce a symlink in the following cases:"),(0,i.mdx)("ul",null,(0,i.mdx)("li",{parentName:"ul"},"The symlink's target was a file, and the file is since modified."),(0,i.mdx)("li",{parentName:"ul"},"The symlink's target was a file, and the file is since deleted or replaced\nwith a different file."),(0,i.mdx)("li",{parentName:"ul"},"An ancestor of the symlink's target was created or deleted or modified."),(0,i.mdx)("li",{parentName:"ul"},"The symlink's target was a directory, and a file is since added or removed\nfrom that directory.")),(0,i.mdx)("h3",{id:"suffix-generator"},"Suffix Generator"),(0,i.mdx)("p",null,"The ",(0,i.mdx)("inlineCode",{parentName:"p"},"suffix")," generator produces a list of files that have a particular suffix or\nset of suffixes. The value can be either a string or an array of strings."),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-bash"},'$ watchman -j <<-EOT\n["query", "/path/to/root", {\n  "suffix": "js"\n}]\nEOT\n')),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-bash"},'$ watchman -j <<-EOT\n["query", "/path/to/root", {\n  "suffix": ["js", "css"]\n}]\nEOT\n')),(0,i.mdx)("p",null,"If the ",(0,i.mdx)("inlineCode",{parentName:"p"},"suffix")," generator is given an empty array, it produces no files."),(0,i.mdx)("p",null,"The ",(0,i.mdx)("inlineCode",{parentName:"p"},"suffix")," generator can produce symlinks."),(0,i.mdx)("p",null,"The ",(0,i.mdx)("inlineCode",{parentName:"p"},"suffix")," generator does not follow symlinks. For example, a symlink to\n",(0,i.mdx)("inlineCode",{parentName:"p"},"/etc")," will not cause a ",(0,i.mdx)("inlineCode",{parentName:"p"},'"suffix": "conf"')," query to search within ",(0,i.mdx)("inlineCode",{parentName:"p"},"/etc")," and\nproduce ",(0,i.mdx)("inlineCode",{parentName:"p"},"/etc/resolv.conf"),"."),(0,i.mdx)("h3",{id:"glob-generator"},"Glob Generator"),(0,i.mdx)("p",null,(0,i.mdx)("em",{parentName:"p"},"Since 4.7.")),(0,i.mdx)("p",null,"The ",(0,i.mdx)("inlineCode",{parentName:"p"},"glob")," generator produces a list of files by matching against your input\nlist of patterns. It does this by building a tree from the glob expression(s)\nand walking both the expression and the in-memory filesystem tree concurrently."),(0,i.mdx)("p",null,"This query will yield a list of all of the C source and header files found\ndirectly in the ",(0,i.mdx)("inlineCode",{parentName:"p"},"src")," dir:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-bash"},'$ watchman -j <<-EOT\n["query", "/path/to/root", {\n  "glob": ["src/*.c", "src/*.h"],\n  "fields": ["name"]\n}]\n')),(0,i.mdx)("p",null,"This query will yield a list of all of the C source and header files found in\nany subdirectories of the root:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-bash"},'$ watchman -j <<-EOT\n["query", "/path/to/root", {\n  "glob": ["**/*.c", "**/*.h"],\n  "fields": ["name"]\n}]\n')),(0,i.mdx)("p",null,"Note that it is more efficient to use the ",(0,i.mdx)("inlineCode",{parentName:"p"},"suffix")," generator together with a\n",(0,i.mdx)("inlineCode",{parentName:"p"},"dirname")," expression term for such a broadly scoped query as it results in fewer\ncomparisons. This example is included as an illustration of recursive globbing."),(0,i.mdx)("p",null,"The glob generator implicitly enables ",(0,i.mdx)("inlineCode",{parentName:"p"},"dedup_results")," mode."),(0,i.mdx)("p",null,"If the ",(0,i.mdx)("inlineCode",{parentName:"p"},"glob")," generator is given an empty array, it produces no files."),(0,i.mdx)("p",null,"The ",(0,i.mdx)("inlineCode",{parentName:"p"},"glob")," generator can produce symlinks."),(0,i.mdx)("p",null,"The ",(0,i.mdx)("inlineCode",{parentName:"p"},"glob")," generator does not follow symlinks. For example, a symlink to ",(0,i.mdx)("inlineCode",{parentName:"p"},"/etc"),"\nwill not cause a ",(0,i.mdx)("inlineCode",{parentName:"p"},'"glob": ["**/resolv.conf"]')," query to search within ",(0,i.mdx)("inlineCode",{parentName:"p"},"/etc")," and\nproduce ",(0,i.mdx)("inlineCode",{parentName:"p"},"/etc/resolv.conf"),"."),(0,i.mdx)("h3",{id:"path-generator"},"Path Generator"),(0,i.mdx)("p",null,"The ",(0,i.mdx)("inlineCode",{parentName:"p"},"path")," generator produces a list of files based on their path and depth.\nDepth controls how far watchman will search down the directory tree for files."),(0,i.mdx)("p",null,"The ",(0,i.mdx)("inlineCode",{parentName:"p"},"path")," generator expects an array of path specifiers. Each path specifier\ncan be either a string or an object and each will produce a set of files."),(0,i.mdx)("p",null,"If it is a string then it is treated as the value for ",(0,i.mdx)("inlineCode",{parentName:"p"},"path")," with ",(0,i.mdx)("inlineCode",{parentName:"p"},"depth")," set to\ninfinite. If an object, the fields ",(0,i.mdx)("inlineCode",{parentName:"p"},"path")," (a string) and ",(0,i.mdx)("inlineCode",{parentName:"p"},"depth")," (an integer)\nmust be supplied."),(0,i.mdx)("p",null,"Paths are relative to the root, so if watchman is watching ",(0,i.mdx)("inlineCode",{parentName:"p"},"/foo/"),", path ",(0,i.mdx)("inlineCode",{parentName:"p"},"bar"),"\nrefers to ",(0,i.mdx)("inlineCode",{parentName:"p"},"/foo/bar"),"."),(0,i.mdx)("p",null,"A ",(0,i.mdx)("inlineCode",{parentName:"p"},"depth")," value of ",(0,i.mdx)("inlineCode",{parentName:"p"},"0")," means only files and directories which are contained in\nthis path. A ",(0,i.mdx)("inlineCode",{parentName:"p"},"depth")," value of ",(0,i.mdx)("inlineCode",{parentName:"p"},"-1")," means no limit on the depth."),(0,i.mdx)("p",null,"The following ",(0,i.mdx)("inlineCode",{parentName:"p"},"path")," generators are equivalent:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-bash"},'$ watchman -j <<-EOT\n["query", "/path/to/root", {\n  "path": ["bar"]\n}]\nEOT\n')),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-bash"},'$ watchman -j <<-EOT\n["query", "/path/to/root", {\n  "path": [{"path": "bar", "depth": -1}]\n}]\nEOT\n')),(0,i.mdx)("p",null,"If the ",(0,i.mdx)("inlineCode",{parentName:"p"},"path")," generator is given an empty array, it produces no files."),(0,i.mdx)("p",null,"The ",(0,i.mdx)("inlineCode",{parentName:"p"},"path")," generator can produce symlinks."),(0,i.mdx)("p",null,"The ",(0,i.mdx)("inlineCode",{parentName:"p"},"path")," generator does not follow symlinks."),(0,i.mdx)("h3",{id:"all-generator"},"All Generator"),(0,i.mdx)("p",null,"The ",(0,i.mdx)("inlineCode",{parentName:"p"},"all")," generator produces a list of all file nodes. It is the default\ngenerator and is used in the case where no other generators were explicitly\nspecified."),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-bash"},'$ watchman -j <<-EOT\n["query", "/path/to/root", {\n}]\nEOT\n')),(0,i.mdx)("p",null,"The ",(0,i.mdx)("inlineCode",{parentName:"p"},"all")," generator can produce symlinks."),(0,i.mdx)("p",null,"The ",(0,i.mdx)("inlineCode",{parentName:"p"},"all")," generator does not follow symlinks."),(0,i.mdx)("h3",{id:"expressions"},"Expressions"),(0,i.mdx)("p",null,"A watchman query expression consists of 0 or more expression terms. If no terms\nare provided then each file evaluated is considered a match (equivalent to\nspecifying a single ",(0,i.mdx)("inlineCode",{parentName:"p"},"true")," expression term)."),(0,i.mdx)("p",null,"Otherwise, the expression is evaluated against the file and produces a boolean\nresult. If that result is true then the file is considered a match and is added\nto the output set."),(0,i.mdx)("p",null,"An expression term is canonically represented as a JSON array whose zeroth\nelement is a string containing the term name."),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-json"},'["termname", arg1, arg2]\n')),(0,i.mdx)("p",null,"If the term accepts no arguments you may use a short form that consists of just\nthe term name expressed as a string:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-json"},'"true"\n')),(0,i.mdx)("p",null,"Expressions that match against file names may match against either the\n",(0,i.mdx)("em",{parentName:"p"},"basename")," or the ",(0,i.mdx)("em",{parentName:"p"},"wholename")," of the file. The basename is the name of the file\nwithin its containing directory. The wholename is the name of the file relative\nto the watched root."),(0,i.mdx)("p",null,"You can find a list of all possible expression terms in the sidebar on the left\nof this page."),(0,i.mdx)("h3",{id:"relative-roots"},"Relative roots"),(0,i.mdx)("p",null,(0,i.mdx)("em",{parentName:"p"},"Since 3.3.")),(0,i.mdx)("p",null,"Watchman supports optionally evaluating queries with respect to a path within a\nwatched root. This is used with the ",(0,i.mdx)("inlineCode",{parentName:"p"},"relative_root")," parameter:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-json"},'["query", "/path/to/watched/root", {\n  "relative_root": "project1",\n}]\n')),(0,i.mdx)("p",null,"Setting a relative root results in the following modifications to queries:"),(0,i.mdx)("ul",null,(0,i.mdx)("li",{parentName:"ul"},"The ",(0,i.mdx)("inlineCode",{parentName:"li"},"path")," generator is evaluated with respect to the relative root. In the\nabove example, ",(0,i.mdx)("inlineCode",{parentName:"li"},'"path": ["dir"]')," will return all files inside\n",(0,i.mdx)("inlineCode",{parentName:"li"},"/path/to/watched/root/project1/dir"),"."),(0,i.mdx)("li",{parentName:"ul"},"The input expression is evaluated with respect to the relative root. In the\nabove example, ",(0,i.mdx)("inlineCode",{parentName:"li"},'"expression": ["match", "dir/*.txt", "wholename"]')," will return\nall files inside ",(0,i.mdx)("inlineCode",{parentName:"li"},"/path/to/watched/root/project1/dir/")," that match the glob\n",(0,i.mdx)("inlineCode",{parentName:"li"},"*.txt"),"."),(0,i.mdx)("li",{parentName:"ul"},"Paths inside the relative root are returned with the relative root stripped\noff. For example, a path ",(0,i.mdx)("inlineCode",{parentName:"li"},"project1/dir/file.txt")," would be returned as\n",(0,i.mdx)("inlineCode",{parentName:"li"},"dir/file.txt"),"."),(0,i.mdx)("li",{parentName:"ul"},"Paths outside the relative root are not returned.")),(0,i.mdx)("p",null,"Relative roots behave similarly to a separate Watchman watch on the\nsubdirectory, without any of the system overhead that that imposes. This is\nuseful for large repositories, where your script or tool is only interested in a\nparticular directory inside the repository."))}c.isMDXComponent=!0}}]);