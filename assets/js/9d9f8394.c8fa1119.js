"use strict";(self.webpackChunkstaticdocs_starter=self.webpackChunkstaticdocs_starter||[]).push([[9360],{3905:function(e,t,n){n.r(t),n.d(t,{MDXContext:function(){return m},MDXProvider:function(){return d},mdx:function(){return f},useMDXComponents:function(){return c},withMDXComponents:function(){return h}});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(){return o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},o.apply(this,arguments)}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var m=a.createContext({}),h=function(e){return function(t){var n=c(t.components);return a.createElement(e,o({},t,{components:n}))}},c=function(e){var t=a.useContext(m),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},d=function(e){var t=c(e.components);return a.createElement(m.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,i=e.parentName,m=l(e,["components","mdxType","originalType","parentName"]),h=c(n),d=r,p=h["".concat(i,".").concat(d)]||h[d]||u[d]||o;return n?a.createElement(p,s(s({ref:t},m),{},{components:n})):a.createElement(p,s({ref:t},m))}));function f(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=p;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var m=2;m<o;m++)i[m]=n[m];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},99222:function(e,t,n){n.r(t),n.d(t,{assets:function(){return h},contentTitle:function(){return l},default:function(){return u},frontMatter:function(){return s},metadata:function(){return m},toc:function(){return c}});var a=n(83117),r=n(80102),o=(n(67294),n(3905)),i=["components"],s={title:"Troubleshooting"},l=void 0,m={unversionedId:"troubleshooting",id:"troubleshooting",title:"Troubleshooting",description:"We try to give directed advice in Watchman error diagnostics, which means that",source:"@site/docs/troubleshooting.md",sourceDirName:".",slug:"/troubleshooting",permalink:"/watchman/docs/troubleshooting",draft:!1,editUrl:"https://github.com/facebook/watchman/tree/main/website/docs/troubleshooting.md",tags:[],version:"current",frontMatter:{title:"Troubleshooting"},sidebar:"tutorialSidebar",previous:{title:"Query Synchronization",permalink:"/watchman/docs/cookies"}},h={},c=[{value:"Ensure that you are on the best available version",id:"ensure-that-you-are-on-the-best-available-version",level:2},{value:"Recrawl",id:"recrawl",level:2},{value:"Avoiding Recrawls",id:"avoiding-recrawls",level:3},{value:"kFSEventStreamEventFlagUserDropped",id:"kfseventstreameventflaguserdropped",level:3},{value:"I&#39;ve changed my limits, how can I clear the warning?",id:"ive-changed-my-limits-how-can-i-clear-the-warning",level:3},{value:"Where are the logs?",id:"where-are-the-logs",level:2},{value:'<a id="poison-inotify-add-watch"></a>Poison: inotify_add_watch',id:"poison-inotify_add_watch",level:2},{value:"I&#39;ve changed my limits, how can I clear the error?",id:"ive-changed-my-limits-how-can-i-clear-the-error",level:3},{value:"Poison: opendir",id:"poison-opendir",level:2},{value:"How do I resolve this?",id:"how-do-i-resolve-this",level:3},{value:"FSEvents",id:"fsevents",level:2},{value:"FSEventStreamStart: register_with_server: ERROR: f2d_register_rpc() =&gt; (null) (-21)",id:"fseventstreamstart-register_with_server-error-f2d_register_rpc--null--21",level:3},{value:"Triggers/Subscriptions don&#39;t fire on macOS",id:"triggerssubscriptions-dont-fire-on-macos",level:2},{value:"ReactNative: Watcher took too long to load",id:"reactnative-watcher-took-too-long-to-load",level:2}],d={toc:c};function u(e){var t=e.components,n=(0,r.Z)(e,i);return(0,o.mdx)("wrapper",(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,o.mdx)("p",null,"We try to give directed advice in Watchman error diagnostics, which means that\nwe will show a link to a section on this page with some context and advice where\nwe have enough information to do so. Some operating systems provide richer\ndiagnostic information than others, so we have to resort to more generic advice\nin some cases."),(0,o.mdx)("p",null,"The most common cause of problems is hitting system resource limits. There are\nfinite resources available for filesystem watching, and when they are exceeded\nit can impact performance in the best case or prohibit correct operation in the\nworst case."),(0,o.mdx)("h2",{id:"ensure-that-you-are-on-the-best-available-version"},"Ensure that you are on the best available version"),(0,o.mdx)("p",null,"It is generally a good idea to make sure that you are using the latest version\nof the software, so that you avoid any known issues."),(0,o.mdx)("p",null,"If you are running a pre-built binary provided by your operating system\ndistribution system, there is a chance that you'll need to build the latest\nversion from source. You can find instructions for this in\n",(0,o.mdx)("a",{parentName:"p",href:"/watchman/docs/install"},"the installation section"),"."),(0,o.mdx)("h2",{id:"recrawl"},"Recrawl"),(0,o.mdx)("p",null,"A recrawl is an action that Watchman performs in order to recover from\nsituations where it believes that it has lost sync with the state of the\nfilesystem."),(0,o.mdx)("p",null,"The most common cause for a recrawl is on Linux systems where the default\ninotify limits are sized quite small. What this means is that the rate at which\nyour watched roots are generating changes is higher than the kernel can buffer\nand relay to the watchman service. When this happens, the kernel detects the\noverflow and signals ",(0,o.mdx)("inlineCode",{parentName:"p"},"IN_Q_OVERFLOW"),". The recovery is to recursively scan the\nroot to make sure that we know what is really there and re-sync with the\nnotification stream."),(0,o.mdx)("p",null,"Frequent recrawls are undesirable because they result in a potentially expensive\nfull tree crawl, which marks all files as changed and propagates this status to\nclients which will in turn perform some action on the (likely falsely) changed\nstate of the majority of files."),(0,o.mdx)("h3",{id:"avoiding-recrawls"},"Avoiding Recrawls"),(0,o.mdx)("p",null,"There is no simple formula for setting your system limits; bigger is better but\ncomes at the cost of kernel memory to maintain the buffers. You and/or your\nsystem administrator should review the workload for your system and the\n",(0,o.mdx)("a",{parentName:"p",href:"/watchman/docs/install#system-specific-preparation"},"System Specific Preparation Documentation"),"\nand raise your limits accordingly."),(0,o.mdx)("h3",{id:"kfseventstreameventflaguserdropped"},"kFSEventStreamEventFlagUserDropped"),(0,o.mdx)("p",null,"macOS has a similar internal limit and behavior when that limit is exceeded. If\nyou're encountering a message like:"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre"},"Recrawled this watch 1 times, most recently because:\n/some/path: kFSEventStreamEventFlagUserDropped\n")),(0,o.mdx)("p",null,"then you are hitting the limits of your system. There is no direct control over\nthe limit, but starting in Watchman 3.2 you may increase the\n",(0,o.mdx)("a",{parentName:"p",href:"/watchman/docs/config#fsevents-latency"},"fsevents_latency")," parameter in your\n",(0,o.mdx)("inlineCode",{parentName:"p"},".watchmanconfig")," file."),(0,o.mdx)("h3",{id:"ive-changed-my-limits-how-can-i-clear-the-warning"},"I've changed my limits, how can I clear the warning?"),(0,o.mdx)("p",null,"The warning will stick until you cancel the watch and reinstate it, or restart\nthe watchman process. The simplest resolution is to run\n",(0,o.mdx)("inlineCode",{parentName:"p"},"watchman shutdown-server")," and re-establish your watch on your next watchman\nquery."),(0,o.mdx)("h2",{id:"where-are-the-logs"},"Where are the logs?"),(0,o.mdx)("p",null,"Watchman places logs in a file named ",(0,o.mdx)("inlineCode",{parentName:"p"},"<STATEDIR>/<USER>.log"),", where ",(0,o.mdx)("inlineCode",{parentName:"p"},"STATEDIR"),"\nis set at the time that you built watchman."),(0,o.mdx)("p",null,"If you used the ",(0,o.mdx)("inlineCode",{parentName:"p"},"--enable-statedir=<STATEDIR>")," configure option, that will be\nthe location that holds your logs. If not, the default for ",(0,o.mdx)("inlineCode",{parentName:"p"},"STATEDIR")," will be\n",(0,o.mdx)("inlineCode",{parentName:"p"},"<PREFIX>/var/run/watchman"),", or for older versions of watchman, the logs may be\nplaced in ",(0,o.mdx)("inlineCode",{parentName:"p"},"<TMPDIR>/.watchman.<USER>.log"),"."),(0,o.mdx)("p",null,(0,o.mdx)("em",{parentName:"p"},"Since 3.8.")),(0,o.mdx)("p",null,"Watchman places the logs in a file named ",(0,o.mdx)("inlineCode",{parentName:"p"},"<STATEDIR>/log"),", which will typically\nbe a location like ",(0,o.mdx)("inlineCode",{parentName:"p"},"<PREFIX>/var/run/watchman/<USER>-state/log"),". If you're\nrunning a ",(0,o.mdx)("inlineCode",{parentName:"p"},"homebrew")," build of watchman, ",(0,o.mdx)("inlineCode",{parentName:"p"},"<PREFIX>")," is usually ",(0,o.mdx)("inlineCode",{parentName:"p"},"/usr/local"),"."),(0,o.mdx)("p",null,"The default log location may be overridden by the ",(0,o.mdx)("inlineCode",{parentName:"p"},"--logfile"),"\n",(0,o.mdx)("a",{parentName:"p",href:"/watchman/docs/cli-options#server-options"},"Server Option"),"."),(0,o.mdx)("p",null,(0,o.mdx)("a",{parentName:"p",href:"/watchman/docs/cli-options#quick-note-on-default-locations"},"Quick note on default locations"),"\nexplains what we mean by ",(0,o.mdx)("inlineCode",{parentName:"p"},"<STATEDIR>"),", ",(0,o.mdx)("inlineCode",{parentName:"p"},"<TMPDIR>"),", ",(0,o.mdx)("inlineCode",{parentName:"p"},"<USER>")," and so on."),(0,o.mdx)("h2",{id:"poison-inotify_add_watch"},(0,o.mdx)("a",{id:"poison-inotify-add-watch"}),"Poison: inotify_add_watch"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre"},"A non-recoverable condition has triggered.  Watchman needs your help!\nThe triggering condition was at timestamp=1407695600: inotify-add-watch(/my/path) -> Cannot allocate memory\nAll requests will continue to fail with this message until you resolve\nthe underlying problem.  You will find more information on fixing this at\nhttps://facebook.github.io/watchman/docs/troubleshooting.html#poison-inotify-add-watch\n")),(0,o.mdx)("p",null,"If you've encountered this state it means that your ",(0,o.mdx)("em",{parentName:"p"},"kernel")," was unable to watch\na dir in one or more of the roots you've asked it to watch. This particular\ncondition is considered non-recoverable by Watchman on the basis that nothing\nthat the Watchman service can do can guarantee that the root cause is resolved,\nand while the system is in this state, Watchman cannot guarantee that it can\nrespond with the correct results that its clients depend upon. We consider\nourselves poisoned and will fail all requests for all watches (not just the\nwatch that it triggered on) until the process is restarted."),(0,o.mdx)("p",null,"There are two primary reasons that this can trigger:"),(0,o.mdx)("ul",null,(0,o.mdx)("li",{parentName:"ul"},"The user limit on the total number of inotify watches was reached or the\nkernel failed to allocate a needed resource"),(0,o.mdx)("li",{parentName:"ul"},"Insufficient kernel memory was available")),(0,o.mdx)("p",null,"The resolution for the former is to revisit\n",(0,o.mdx)("a",{parentName:"p",href:"/watchman/docs/install#system-specific-preparation"},"System Specific Preparation Documentation"),"\nand raise your limits accordingly."),(0,o.mdx)("p",null,"The latter condition implies that your workload is exceeding the available RAM\non the machine. It is difficult to give specific advice to resolve this\ncondition here; you may be able to tune down other system limits to free up some\nresources, or you may just need to install more RAM in the system."),(0,o.mdx)("h3",{id:"ive-changed-my-limits-how-can-i-clear-the-error"},"I've changed my limits, how can I clear the error?"),(0,o.mdx)("p",null,"The error will stick until you restart the watchman process. The simplest\nresolution is:"),(0,o.mdx)("p",null,(0,o.mdx)("em",{parentName:"p"},"Since 4.6")),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre",className:"language-bash"},"$ watchman watch-del-all\n$ watchman shutdown-server\n")),(0,o.mdx)("p",null,(0,o.mdx)("em",{parentName:"p"},"Before 4.6")),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre",className:"language-bash"},"$ rm <STATEDIR>/state       # see above for what STATEDIR means\n$ watchman --no-spawn --no-local shutdown-server\n")),(0,o.mdx)("p",null,"If you have not actually resolved the root cause you may continue to trigger and\nexperience this state each time the system trips over these limits."),(0,o.mdx)("h2",{id:"poison-opendir"},"Poison: opendir"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre"},"A non-recoverable condition has triggered.  Watchman needs your help!\nThe triggering condition was at timestamp=1407695600: opendir(/my/path) -> Too many open files in system\nAll requests will continue to fail with this message until you resolve\nthe underlying problem.  You will find more information on fixing this at\nhttps://facebook.github.io/watchman/docs/troubleshooting.html#opendir\n")),(0,o.mdx)("p",null,"If you've encountered this state it means that your entire system had too many\nopen files, and that this prevented watchman from tracking the changes on your\nsystem. In this case, the error isn't related to filesystem watching but to\nother (likely) misbehaving processes on your system; it's usually indicative of\na runaway program or set of programs consuming resources, but in some cases it\nmay just be that your system workload requires that you increase your system\nlimits for the number of files."),(0,o.mdx)("h3",{id:"how-do-i-resolve-this"},"How do I resolve this?"),(0,o.mdx)("p",null,(0,o.mdx)("a",{parentName:"p",href:"/watchman/docs/troubleshooting#i-39-ve-changed-my-limits-how-can-i-clear-the-error"},"Follow these directions")),(0,o.mdx)("p",null,"If the issue persists, consult your system administrator to identify what is\nconsuming these resources and remediate it, or to increase your system limits."),(0,o.mdx)("h2",{id:"fsevents"},"FSEvents"),(0,o.mdx)("p",null,"FSEvents is the file watching facility on macOS. There are few diagnostics that\ncan help diagnose issues with FSEvents; the API itself gives little feedback on\na number of error cases and instead emits rather cryptic error messages to the\nlog file."),(0,o.mdx)("p",null,"If you got here because an error message told you to read this section, it will\nhave also asked you to look at your log file. If you are using an older version\nof watchman and encounter the error message ",(0,o.mdx)("inlineCode",{parentName:"p"},"FSEventStreamStart failed"),", then\nyou should locate your log file (see ",(0,o.mdx)("a",{parentName:"p",href:"#where-are-the-logs"},"Where are the logs?"),"\nabove) and look for lines that mention FSEvents and then consult the information\nbelow."),(0,o.mdx)("h3",{id:"fseventstreamstart-register_with_server-error-f2d_register_rpc--null--21"},"FSEventStreamStart: register_with_server: ERROR: f2d_register_rpc() => (null) (-21)"),(0,o.mdx)("p",null,"Nobody outside of Apple is sure what precisely this means, but it indicates that\nthe fsevents service has gotten in a bad state. Possible reasons for this may\ninclude:"),(0,o.mdx)("ul",null,(0,o.mdx)("li",{parentName:"ul"},"There are too many event stream clients"),(0,o.mdx)("li",{parentName:"ul"},"One or more event stream clients has gotten in a bad state and is somehow\nimpacting the fsevents service")),(0,o.mdx)("p",null,"To resolve this issue, you may wish to try the following, which are\nprogressively more invasive:"),(0,o.mdx)("ul",null,(0,o.mdx)("li",{parentName:"ul"},"Avoid establishing multiple overlapping watches within the same filesystem\ntree, especially for large trees. We recommend watching only the root of a\nproject or repo and not watching sub-trees within that tree. Organizations\nwith large trees may wish to deploy the\n",(0,o.mdx)("a",{parentName:"li",href:"/watchman/docs/config#root-restrict-files"},"root_restrict_files")," configuration option so\nthat watchman will only allow watching project roots."),(0,o.mdx)("li",{parentName:"ul"},"Close or restart other applications that are using fsevents. Some examples\nare:"),(0,o.mdx)("li",{parentName:"ul"},"editors such as Sublime Text and TextMate."),(0,o.mdx)("li",{parentName:"ul"},"Many nodejs packages and Grunt style workflows make use of fsevents. Make sure\nthat you upgrade nodejs to at least version ",(0,o.mdx)("inlineCode",{parentName:"li"},"v0.11.14"),". If possible, configure\nyour nodejs packages to use either ",(0,o.mdx)("a",{parentName:"li",href:"https://www.npmjs.com/package/sane"},"sane"),"\nor ",(0,o.mdx)("a",{parentName:"li",href:"https://www.npmjs.com/package/fb-watchman"},"fb-watchman")," for file watching\nas this will consolidate the number of fsevents watches down to just the set\nmaintained by watchman."),(0,o.mdx)("li",{parentName:"ul"},"Restart the fsevents service: ",(0,o.mdx)("inlineCode",{parentName:"li"},"sudo pkill -9 -x fseventsd")),(0,o.mdx)("li",{parentName:"ul"},"Restart your computer")),(0,o.mdx)("h2",{id:"triggerssubscriptions-dont-fire-on-macos"},"Triggers/Subscriptions don't fire on macOS"),(0,o.mdx)("p",null,"There is a rare fsevents bug that can prevent any notifications from working in\ndirectories where the case of the name of a directory in the kernel has an\ninconsistency."),(0,o.mdx)("p",null,"You can test whether this is happening to you by following\n",(0,o.mdx)("a",{parentName:"p",href:"https://github.com/andreyvit/find-fsevents-bugs"},"the instructions for the find-fsevents-bugs tool"),"."),(0,o.mdx)("p",null,"If it is happening to you, the resolution is to rename the directories\nhighlighted by the tool."),(0,o.mdx)("p",null,"You can read more about this issue in the following resources:"),(0,o.mdx)("ul",null,(0,o.mdx)("li",{parentName:"ul"},(0,o.mdx)("a",{parentName:"li",href:"http://feedback.livereload.com/knowledgebase/articles/86239-os-x-fsevents-bug-may-prevent-monitoring-of-certai"},"Knowledge base article for LiveReload")),(0,o.mdx)("li",{parentName:"ul"},(0,o.mdx)("a",{parentName:"li",href:"https://github.com/thibaudgg/rb-fsevent/issues/10"},"issue for the Ruby fsevents module")),(0,o.mdx)("li",{parentName:"ul"},(0,o.mdx)("a",{parentName:"li",href:"http://openradar.appspot.com/10207999"},"Open Radar bug report"))),(0,o.mdx)("h2",{id:"reactnative-watcher-took-too-long-to-load"},"ReactNative: Watcher took too long to load"),(0,o.mdx)("p",null,"There was an issue that was the result of umask affecting the permissions of the\nlaunchd plist file that Watchman uses to set up your watchman service on OS X.\nThis issue was resolved in Watchman version 3.1."),(0,o.mdx)("p",null,"To update:"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre",className:"language-bash"},"$ watchman shutdown-server\n$ brew update\n$ brew reinstall watchman\n")))}u.isMDXComponent=!0}}]);